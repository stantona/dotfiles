#!/usr/bin/env bash

set -e

CONFIG="install.conf.yaml"
DOTBOT_DIR="dotbot"

DOTBOT_BIN="bin/dotbot"
BASEDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

cd "${BASEDIR}"
git -C "${DOTBOT_DIR}" submodule sync --quiet --recursive
git submodule update --init --recursive "${DOTBOT_DIR}"

# Install configuration for all profiles
for PROFILE_DIR in profiles/*; do
  PROFILE="$(basename "${PROFILE_DIR}")"

  if [[  ! -f "${PROFILE_DIR}/run_profile" ]]; then
    echo "No ${PROFILE_DIR}/run_profile file for profile ${PROFILE}; skipping"
    continue
  fi

  if "${PROFILE_DIR}"/run_profile; then
    printf "\033[0;32mProfile ${PROFILE} detected: running dotbot\033[0m\n"
     "${BASEDIR}/${DOTBOT_DIR}/${DOTBOT_BIN}" -d "${BASEDIR}" -c "${PROFILE_DIR}/install.conf.yaml" "${@}"
  fi
done
